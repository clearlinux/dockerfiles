FROM clearlinux:latest as builder

ARG swupd_args

# Move to latest Clear Linux release to ensure
# that the swupd command line arguments are
# correct
RUN swupd update --no-boot-update $swupd_args

# Grab os-release info from the minimal base image so
# that the new content matches the exact OS version
COPY --from=clearlinux/os-core:latest /usr/lib/os-release /

# Install additional content in a target directory
# using the os version from the minimal base
RUN source /os-release && \
    mkdir /install_root \
    && swupd os-install -V ${VERSION_ID} \
    --path /install_root --statedir /swupd-state \
    --bundles=mariadb --no-scripts \
    && rm -rf /install_root/var/lib/swupd/*

FROM clearlinux/os-core:latest
MAINTAINER qi.zheng@intel.com

COPY --from=builder /install_root /

RUN mkdir /docker-entrypoint-initdb.d
RUN set -ex; \
	rm -rf /var/lib/mysql; \
	mkdir -p /var/lib/mysql /var/run/mariadb /etc/mariadb; \
	chown -R mysql:mysql /var/lib/mysql /var/run/mariadb; \
	chmod 777 /var/run/mariadb; 

VOLUME /var/lib/mysql

COPY docker-entrypoint.sh /usr/local/bin/
RUN chmod +x /usr/local/bin/docker-entrypoint.sh
COPY my.cnf /etc/mariadb/

ENTRYPOINT ["docker-entrypoint.sh"]

EXPOSE 3306
CMD ["mysqld"]
